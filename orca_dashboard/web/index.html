<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCA Dashboard</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent: #00bcd4;
            --card-bg: #1e1e1e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--accent);
            border: none;
            padding: 10px 20px;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.9;
        }

        #timeline {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            min-height: 300px;
            border: 1px solid #333;
        }

        .event-item {
            border-bottom: 1px solid #333;
            padding: 8px 0;
            font-family: monospace;
        }

        #settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #252525;
            padding: 20px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <div class="header">
        <div>
            <h1>ORCA Control</h1>
            <div id="provider-status" style="font-size: 0.9em; color: #888;">Local AI: Checking...</div>
        </div>
        <div class="controls">
            <button id="btn-start" onclick="startRun()">Start Run</button>
            <button id="btn-close" onclick="closeRun()">Close Run</button>
            <button onclick="toggleSettings()">⚙️</button>
        </div>
    </div>

    <!-- LLM Input Zone -->
    <div
        style="background: var(--card-bg); padding: 10px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #333;">
        <textarea id="llm-prompt"
            style="width: 100%; height: 60px; background: #000; color: #fff; border: 1px solid #444; padding: 5px;"
            placeholder="Enter LLM prompt..."></textarea>
        <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
            <button onclick="runLLM()" style="font-size: 0.9em;">Run LLM</button>
            <span id="llm-status" style="font-size: 0.8em; color: #aaa;"></span>
        </div>
        <div id="llm-output"
            style="margin-top: 10px; white-space: pre-wrap; color: #00bcd4; font-family: monospace; display: none;">
        </div>
    </div>

    <div id="timeline">
        <div style="color: #666;">Waiting for events...</div>
    </div>

    <div id="settings-modal">
        <h3>Settings</h3>
        <label><input type="checkbox" id="dark-mode" checked> Dark Mode</label>
        <br><br>
        <button onclick="toggleSettings()">Close</button>
    </div>

    <script>
        const API_BASE = "http://localhost:8001/api";
        const WS_URL = "ws://localhost:8001/api/ws/events";

        let currentRunId = null;
        let ws = null;

        function initWS() {
            ws = new WebSocket(WS_URL);
            ws.onmessage = (event) => {
                const timeline = document.getElementById('timeline');

                // Handle raw text messages (old smoke tests)
                if (!event.data.startsWith("{")) {
                    const div = document.createElement('div');
                    div.className = 'event-item';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${event.data}`;
                    timeline.prepend(div);
                    return;
                }

                // Parse JSON Events
                try {
                    const evt = JSON.parse(event.data);

                    // 1. Handle Streaming Text (llm.delta)
                    if (evt.type === "llm.delta") {
                        const outDiv = document.getElementById('llm-output');
                        if (outDiv.style.display !== 'none') {
                            outDiv.textContent += evt.delta;
                        }
                        return; // Don't spam timeline
                    }

                    // 2. Handle Completion (llm.completed)
                    if (evt.type === "llm.completed") {
                        const statusSpan = document.getElementById('llm-status');
                        statusSpan.textContent = `Completed: ${evt.provider_id} / ${evt.model}`;
                    }

                    // 3. Handle Artifacts
                    if (evt.type === "artifact.written" && evt.kind === "llm_output") {
                        const div = document.createElement('div');
                        div.className = 'event-item';
                        div.style.color = "#4caf50";
                        div.textContent = `[Artifact] Saved ${evt.path} (SHA256: ${evt.sha256.substring(0, 8)}...)`;
                        timeline.prepend(div);
                        return;
                    }

                    // Log other structured events to timeline
                    const div = document.createElement('div');
                    div.className = 'event-item';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${evt.type}`;
                    timeline.prepend(div);

                } catch (e) {
                    // Fallback for non-JSON
                    const div = document.createElement('div');
                    div.className = 'event-item';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${event.data}`;
                    timeline.prepend(div);
                }
            };
            ws.onopen = () => console.log("Connected to ORCA WS");
        }

        async function startRun() {
            try {
                const res = await fetch(`${API_BASE}/runs/start`, { method: 'POST' });
                const data = await res.json();
                currentRunId = data.run_id;
                console.log("Run started:", currentRunId);
            } catch (e) { console.error(e); }
        }

        async function closeRun() {
            if (!currentRunId) return alert("No active run");
            await fetch(`${API_BASE}/runs/${currentRunId}/close`, { method: 'POST' });
            console.log("Run closed");
            currentRunId = null;
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        // Save settings to localStorage
        document.getElementById('dark-mode').addEventListener('change', (e) => {
            localStorage.setItem('orca_dark_mode', e.target.checked);
        });

        // Init
        initWS();
        checkProvider();

        async function checkProvider() {
            const statusDiv = document.getElementById('provider-status');
            try {
                const res = await fetch(`${API_BASE}/providers/probe`);
                const data = await res.json();
                const ollama = data.probes.find(p => p.name === 'ollama_local');

                if (ollama) {
                    if (ollama.models && ollama.models.length > 0) {
                        statusDiv.innerHTML = `Local AI: <span style="color: #4caf50">● Ollama Ready</span> (${ollama.models[0]})`;
                    } else {
                        statusDiv.innerHTML = `Local AI: <span style="color: orange">● Ollama Detected (No Models)</span> <button onclick="pullModel()" style="padding: 2px 8px; font-size: 0.8em;">Install Default</button>`;
                    }
                } else {
                    statusDiv.innerHTML = `Local AI: <span style="color: #f44336">○ Not Detected</span>`;
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `Local AI: Error (CORS?). <span style="font-size:0.8em">Tip: run <code>python -m http.server 5173</code></span>`;
            }
        }

        async function runLLM() {
            const prompt = document.getElementById('llm-prompt').value;
            if (!prompt) return alert("Enter a prompt");

            if (!currentRunId) {
                await startRun();
            }

            const statusSpan = document.getElementById('llm-status');
            const outDiv = document.getElementById('llm-output');

            statusSpan.textContent = "Generating...";
            outDiv.style.display = "block";
            outDiv.textContent = "";

            try {
                const res = await fetch(`${API_BASE}/llm/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        run_id: currentRunId,
                        prompt: prompt,
                        stream: true
                    })
                });
                const data = await res.json();

                if (data.error) {
                    outDiv.textContent = "Error: " + data.error;
                    statusSpan.textContent = "Failed";
                }
                // Don't overwrite outDiv here if streaming happened, 
                // but if stream=false was forced by server (e.g. stub), update it.
                // The router returns the full text preview in both cases.
                // If we relied only on stream, we wouldn't use this. 
                // But since we clear it above, we should trust the WS stream OR the final payload.
                // Best UX: if empty (WS failed?), use payload.
                if (outDiv.textContent.length === 0) {
                    outDiv.textContent = data.output_preview;
                }
            } catch (e) {
                console.error(e);
                statusSpan.textContent = "Network Error";
            }
        }

        async function pullModel() {
            await fetch(`${API_BASE}/providers/ollama/pull_default`, { method: 'POST' });
            alert("Pulling llama3 in background... check events timeline.");
        }
    </script>

</body>

</html>