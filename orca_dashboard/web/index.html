<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCA Dashboard</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent: #00bcd4;
            --card-bg: #1e1e1e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--accent);
            border: none;
            padding: 10px 20px;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background: #444 !important;
            color: #888 !important;
            cursor: not-allowed !important;
        }

        #timeline {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            border: 1px solid #333;
        }

        .event-item {
            border-bottom: 1px solid #333;
            padding: 8px 0;
            font-family: monospace;
            font-size: 0.85em;
        }

        #settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #252525;
            padding: 20px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        /* Persona Styles */
        .persona-bar {
            background: #1e1e1e;
            padding: 8px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .persona-btn {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .persona-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .persona-btn.locked {
            border-style: dotted;
            opacity: 0.8;
            color: #aaa;
        }

        .locked-banner {
            background: #b71c1c;
            color: #fff;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
        }

        .content-main {
            padding: 20px;
        }

        .orca-module {
            margin-bottom: 20px;
        }

        .module-placeholder {
            background: #1a1a1a;
            border: 1px dashed #444;
            padding: 20px;
            text-align: center;
            color: #666;
            border-radius: 8px;
        }

        /* Marketplace Styles */
        #marketplace-modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e1e1e;
            width: 80%;
            max-width: 800px;
            height: 70vh;
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 25px;
            border-radius: 12px;
            overflow-y: auto;
        }

        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .persona-card {
            background: #252525;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.2s;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .status-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .status-badge.unlocked {
            background: #2e7d32;
            color: #fff;
        }

        .status-badge.locked {
            background: #c62828;
            color: #fff;
        }

        .status-badge.installed {
            border: 1px solid #666;
            color: #aaa;
        }

        .management-section {
            border-top: 1px solid #444;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 0.8em;
        }

        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .preview-details {
            font-size: 0.85em;
            background: #111;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .director-tab {
            background: #111;
            color: #666;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.8em;
            font-family: inherit;
        }

        .director-tab.active {
            background: #1a1a2e;
            color: #5c6bc0;
            border-bottom: 2px solid #5c6bc0;
        }

        .inbox-item {
            padding: 10px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .inbox-item:hover {
            background: #111;
        }

        .inbox-item.active {
            background: #1a1a2e;
            border-left: 3px solid #5c6bc0;
        }

        .quest-item {
            padding: 10px;
            border-bottom: 1px solid #222;
            background: #0b0b0f;
            cursor: pointer;
            font-size: 0.85em;
        }

        .quest-item:hover {
            background: #111;
        }

        .quest-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .quest-card-title {
            color: #eee;
            font-weight: bold;
        }

        .quest-card-meta {
            color: #666;
            font-size: 0.75em;
        }

        .progress-col {
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            background: #0b0b0f;
        }

        .progress-header {
            padding: 10px;
            background: #111;
            border-bottom: 1px solid #333;
            font-size: 0.8em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-card {
            padding: 10px;
            border-bottom: 1px solid #222;
            font-size: 0.85em;
        }

        .severity-crit {
            border-left: 3px solid #ff1744;
        }

        .severity-high {
            border-left: 3px solid #ff9100;
        }

        .severity-med {
            border-left: 3px solid #ffea00;
        }

        .severity-low {
            border-left: 3px solid #00e676;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #111;
            padding: 20px;
            border: 1px solid #333;
            width: 400px;
            color: #eee;
        }
    </style>
</head>

<body class="safe-ui">

    <div id="locked-banner" class="locked-banner">
        üîí LOCKED PREVIEW ‚Äî Enterprise features restricted. [Activate Professional]
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 1.5em;">ORCA Dashboard</h1>
            <div style="display: flex; gap: 15px; align-items: baseline; margin-top: 5px;">
                <div id="provider-status" style="font-size: 0.9em; color: #888;">Local AI: Checking...</div>
                <div id="system-time" style="font-size: 0.9em; color: #aaa;"></div>
                <div id="location-status" style="font-size: 0.9em; color: #aaa;">Location: off</div>
            </div>
        </div>
        <div class="controls">
            <button onclick="enableLocation()" title="Enable Location">üìç</button>
            <input type="file" id="file-upload" style="display: none;" onchange="uploadFile(this)">
            <button onclick="document.getElementById('file-upload').click()">Upload</button>
            <button id="btn-start" onclick="startRun()">Start</button>
            <button onclick="toggleSettings()">‚öôÔ∏è</button>
            <button onclick="toggleDirector()" style="background:#5c6bc0; color:#fff;">Director</button>
        </div>
    </div>

    <!-- Director Console Modal (Enhanced) -->
    <div id="director-modal"
        style="display: none; position: fixed; top: 10%; left: 10%; width: 80%; height: 80vh; background: #0b0b0f; border: 2px solid #5c6bc0; z-index: 3000; padding: 0; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.9); overflow: hidden; display: flex; flex-direction: column; font-family: 'Consolas', monospace;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; background: #1a1a2e; border-bottom: 2px solid #5c6bc0; padding: 10px 20px;">
            <h2 style="margin: 0; color: #5c6bc0; font-size: 1.2em;">ORCA // DIRECTOR_FLIGHT_RECORDER_v1.0</h2>
            <div id="director-hud" style="display: flex; gap: 20px; font-size: 0.8em; color: #aaa;">
                <span>STATUS: <b id="hud-status" style="color: #4caf50;">ONLINE</b></span>
                <span>INBOX: <b id="hud-inbox">0</b></span>
                <span>QUESTS: <b id="hud-quests">0</b></span>
                <span>RUNS: <b id="hud-runs">0</b></span>
            </div>
            <button onclick="toggleDirector()"
                style="background: #c62828; color: #fff; border: none; padding: 5px 15px; cursor: pointer;">EXIT</button>
        </div>

        <div style="display: flex; background: #111; border-bottom: 1px solid #333;">
            <button onclick="switchDirectorTab('recorder', this)" class="director-tab active">FLIGHT_RECORDER</button>
            <button onclick="switchDirectorTab('inbox', this)" class="director-tab">INBOX_ASSETS</button>
            <button onclick="switchDirectorTab('quests', this)" class="director-tab">QUEST_LIFECYCLE</button>
            <button onclick="switchDirectorTab('progress', this)" class="director-tab">PROGRESS_CENTER</button>
        </div>

        <div id="director-recorder-view"
            style="display: grid; grid-template-columns: 2fr 1fr; gap: 0; flex: 1; overflow: hidden;">
            <!-- Live Feed -->
            <div style="border-right: 1px solid #333; display: flex; flex-direction: column; background: #000;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; color: #5c6bc0; font-size: 0.8em; font-weight: bold;">
                    LIVE_EVENT_STREAM</div>
                <div id="director-event-stream"
                    style="flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85em; color: #0f0;">
                    <!-- Events append here -->
                    [SYSTEM] INITIALIZING RECORDER...
                </div>
            </div>

            <!-- Run Receipts -->
            <div style="display: flex; flex-direction: column; background: #0b0b0f;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; color: #5c6bc0; font-size: 0.8em; font-weight: bold;">
                    RUN_RECEIPTS</div>
                <div id="director-run-list" style="flex: 1; overflow-y: auto; padding: 10px;">
                    <!-- Runs here -->
                </div>
                <div style="padding: 15px; border-top: 1px solid #333; background: #111;">
                    <button onclick="triggerTestEvent()"
                        style="width: 100%; background: #333; color: #aaa; border: 1px solid #444; padding: 8px; font-size: 0.8em; cursor: pointer;">SEND
                        TEST_EVENT</button>
                </div>
            </div>
        </div>

        <!-- Inbox View -->
        <div id="director-inbox-view"
            style="display: none; grid-template-columns: 1fr 2fr; gap: 0; flex: 1; overflow: hidden;">
            <div style="border-right: 1px solid #333; display: flex; flex-direction: column; background: #000;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #5c6bc0; font-size: 0.8em; font-weight: bold;">INBOX_ASSETS</span>
                    <input type="file" id="inbox-upload-input" style="display: none;" onchange="uploadInboxFile()">
                    <button onclick="document.getElementById('inbox-upload-input').click()"
                        style="background: #2e7d32; color: #fff; border: none; font-size: 0.7em; padding: 2px 8px; cursor: pointer;">UPLOAD</button>
                </div>
                <div id="inbox-item-list" style="flex: 1; overflow-y: auto;">
                    <!-- Inbox items here -->
                </div>
            </div>
            <div id="inbox-preview-pane"
                style="background: #0b0b0f; display: flex; flex-direction: column; padding: 20px; overflow-y: auto;">
                <div style="color: #666; font-size: 0.9em; text-align: center; margin-top: 50px;">Select an item to
                    preview</div>
            </div>
        </div>

        <!-- Quests View -->
        <div id="director-quests-view"
            style="display: none; grid-template-columns: 1fr 1fr 1fr; gap: 0; flex: 1; overflow: hidden;">
            <div style="border-right: 1px solid #333; display: flex; flex-direction: column; background: #0b0b0f;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; color: #4caf50; font-size: 0.8em; font-weight: bold;">
                    ACTIVE_QUEUE</div>
                <div id="quest-list-active" style="flex: 1; overflow-y: auto;"></div>
            </div>
            <div style="border-right: 1px solid #333; display: flex; flex-direction: column; background: #0b0b0f;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; color: #ff9800; font-size: 0.8em; font-weight: bold;">
                    NEXT_UP</div>
                <div id="quest-list-next" style="flex: 1; overflow-y: auto;"></div>
            </div>
            <div style="display: flex; flex-direction: column; background: #0b0b0f;">
                <div
                    style="padding: 10px; background: #111; border-bottom: 1px solid #333; color: #aaa; font-size: 0.8em; font-weight: bold;">
                    LATER_BACKLOG</div>
                <div id="quest-list-later" style="flex: 1; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Progress View -->
        <div id="director-progress-view"
            style="display: none; height: 100%; grid-template-columns: repeat(4, 1fr); overflow: hidden; background: #050507; flex: 1;">
            <div class="progress-col">
                <div class="progress-header">MILESTONES (MAP)</div>
                <div id="progress-milestones-list" style="flex: 1; overflow-y: auto;"></div>
            </div>
            <div class="progress-col">
                <div class="progress-header">CAPABILITIES (PIPELINES)</div>
                <div id="progress-capabilities-list" style="flex: 1; overflow-y: auto;"></div>
            </div>
            <div class="progress-col">
                <div class="progress-header">QUESTS (LOG)</div>
                <div id="progress-quests-list" style="flex: 1; overflow-y: auto;"></div>
            </div>
            <div class="progress-col" style="border-right: none;">
                <div class="progress-header">
                    ISSUES (HOTFIXES)
                    <button onclick="createIssueDialog()"
                        style="background: #ff1744; border: none; color: #fff; font-size: 0.7em; cursor: pointer; padding: 2px 5px;">NEW</button>
                </div>
                <div id="progress-issues-list" style="flex: 1; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div class="persona-bar">
        <span style="font-size: 0.75em; color: #666; text-transform: uppercase;">Context:</span>
        <div id="persona-list" style="display: flex; gap: 10px;">
            <!-- Personas loaded dynamically -->
        </div>
        <button onclick="toggleMarketplace()"
            style="background:none; color:var(--accent); border:1px solid var(--accent); font-size:0.75em; padding:2px 8px; margin-left:auto;">Store
            / Marketplace</button>
    </div>
    </div>

    <div class="content-main">

        <!-- Chat Module -->
        <div id="chat.basic" class="orca-module" style="display: block;">
            <div
                style="background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; height: 400px;">
                <div id="chat-history"
                    style="flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; border: 1px solid #444; background: #121212; display: flex; flex-direction: column; gap: 10px;">
                    <div style="text-align: center; color: #666; font-size: 0.9em;">Ready for interaction</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input"
                        style="flex: 1; background: #252525; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px;"
                        placeholder="Message Orca..." onkeydown="if(event.key==='Enter') sendChat()">
                    <button class="action-btn" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>

        <!-- Advanced Chat Indicator (M8) -->
        <div id="chat.advanced" class="orca-module"
            style="display: none; padding: 10px; background: #002b36; border: 1px solid var(--accent); border-radius: 8px; margin-bottom: 20px;">
            <span style="color:var(--accent); font-weight:bold;">‚ú® STREAMING ENABLED</span>
        </div>

        <!-- TTS Module -->
        <div id="tts.standard" class="orca-module"
            style="display: block; padding: 15px; background: #1e1e1e; border-radius: 8px; border: 1px solid #333;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="action-btn" onclick="speakLastResponse()">Speak Response</button>
                <span id="tts-status" style="font-size: 0.9em; color: #888;"></span>
                <a id="tts-download" href="#" download
                    style="font-size: 0.9em; color: #00bcd4; display: none;">Download</a>
            </div>
            <div id="tts-progress" style="margin-top: 8px; display: none;">
                <div style="height: 4px; background: #111; border-radius: 2px; overflow: hidden;">
                    <div id="tts-progress-bar" style="height: 100%; width: 0%; background: #00bcd4;"></div>
                </div>
            </div>
            <canvas id="tts-waveform" height="40"
                style="width: 100%; margin-top: 10px; display: none; background: #111; border-radius: 4px;"></canvas>
            <audio id="tts-player" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
        </div>

        <!-- Provenance Viewer / Timeline -->
        <div id="provenance.viewer" class="orca-module" style="display: block;">
            <div id="timeline">
                <div style="color: #666; font-size: 0.9em; margin-bottom: 10px;">PROVENANCE TIMELINE</div>
                <div id="event-list"></div>
            </div>
        </div>

        <!-- Professional Modules (Hidden by default) -->
        <div id="provenance.bundle" class="orca-module"
            style="display: none; padding: 20px; background: #1a1a1a; border: 1px solid #444; border-radius: 8px;">
            <h3 style="margin-top:0;">F-Stack Bundle Generator</h3>
            <p style="font-size: 0.85em; color: #888;">Generate cryptographically signed compliance bundles.</p>
            <button class="action-btn" onclick="alert('Exporting verified bundle...')">Generate Bundle</button>
        </div>

        <div id="admin.audit" class="orca-module"
            style="display: none; padding: 20px; background: #1a1a1a; border: 1px solid #c62828; border-radius: 8px;">
            <h3 style="margin-top:0; color: #f44336;">Admin Audit Logs</h3>
            <p style="font-size: 0.85em; color: #888;">Low-level system activity tracking.</p>
            <button class="action-btn" onclick="alert('Accessing secure logs...')">View Audit Trail</button>
        </div>

    </div>

    <div id="settings-modal">
        <h3>Settings</h3>
        <fieldset style="border: 1px solid #444; padding: 10px; margin-bottom: 15px;">
            <legend>Mode</legend>
            <select id="chat-mode" onchange="saveRuntimeSettings()">
                <option value="offline">Offline</option>
                <option value="cloud">Cloud</option>
                <option value="hybrid">Hybrid</option>
            </select>
            <select id="tts-mode" onchange="saveRuntimeSettings()">
                <option value="offline">Offline</option>
                <option value="cloud">Cloud</option>
                <option value="hybrid">Hybrid</option>
            </select>
        </fieldset>

        <fieldset style="border: 1px solid #444; padding: 10px; margin-bottom: 15px;">
            <legend>Chat Provider</legend>
            <select id="chat-provider" onchange="updateChatModels(); saveRuntimeSettings();"></select>
            <select id="model-select" onchange="saveRuntimeSettings()"></select>
        </fieldset>

        <fieldset style="border: 1px solid #444; padding: 10px; margin-bottom: 15px;">
            <legend>TTS Engine</legend>
            <select id="tts-provider-select" onchange="updateTTSModels(); saveRuntimeSettings();"></select>
            <select id="tts-model-select" onchange="saveRuntimeSettings()"></select>
            <select id="voice-select" onchange="saveRuntimeSettings()"></select>
        </fieldset>

        <button onclick="toggleSettings()">Done</button>
    </div>

    <!-- Marketplace Modal (M9) -->
    <div id="marketplace-modal">
        <div
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 15px;">
            <h2 style="margin:0; color:var(--accent);">ORCA Marketplace & Persona Manager</h2>
            <button onclick="toggleMarketplace()" style="background:#444; color:#fff; padding:5px 15px;">Close</button>
        </div>
        <div id="marketplace-content" class="marketplace-grid">
            <!-- Dynamic Cards -->
            <div style="color:#666;">Loading catalog...</div>
        </div>

        <div id="import-section" style="margin-top:20px; border-top:1px solid #444; padding-top:15px;">
            <h3 style="color:var(--accent); margin-top:0; font-size:1em;">Import Persona Pack (.zip)</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="import-zip-path" placeholder="C:\path\to\persona.zip"
                    style="flex:1; padding:8px; background:#111; border:1px solid #444; color:#fff;">
                <button onclick="importPersonaZip()"
                    style="padding:8px 20px; background:var(--accent); color:#000; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">Import</button>
            </div>
            <div id="import-status" style="margin-top:8px; font-size:0.85em;"></div>
        </div>

        <div id="preview-panel" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:20px;">
            <h3 id="preview-title" style="color:var(--accent); margin-top:0;">Preview</h3>
            <div id="preview-body" class="preview-details"></div>
            <button onclick="exitPreview()" style="margin-top:10px; background:#c62828; color:#fff;">Exit
                Preview</button>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8001/api";
        const RUNTIME_BASE = "http://127.0.0.1:7010";

        let currentRunId = null;
        let lockedMode = false;
        let currentAssistantDiv = null;

        // --- Persona Logic (M8) ---

        async function loadPersonas() {
            try {
                // We use 'enterprise' cap profile to see everything possible
                const res = await fetch(`${RUNTIME_BASE}/runtime/persona/list?cap_profile=enterprise`);
                const personas = await res.json();
                const list = document.getElementById('persona-list');
                list.innerHTML = "";

                // Get active persona to mark button
                const activeRes = await fetch(`${RUNTIME_BASE}/runtime/persona/active`);
                const activeData = await activeRes.json();

                personas.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `persona-btn ${p.status === 'LOCKED_PREVIEW' ? 'locked' : ''} ${p.id === activeData.id ? 'active' : ''}`;
                    btn.textContent = p.label;
                    btn.onclick = () => switchPersona(p.id, p.status);
                    list.appendChild(btn);
                });

                // Apply initial layout
                applyPersonaLayout(activeData);
            } catch (e) {
                console.error("Failed to load personas", e);
            }
        }

        async function switchPersona(id, status) {
            try {
                let res;
                if (status === 'LOCKED_PREVIEW') {
                    // Just preview it
                    res = await fetch(`${RUNTIME_BASE}/runtime/persona/preview?persona_id=${id}&cap_profile=enterprise`);
                } else {
                    // Full switch
                    res = await fetch(`${RUNTIME_BASE}/runtime/persona/switch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ persona_id: id })
                    });
                }
                const personaUpdate = await res.json();
                applyPersonaLayout(personaUpdate);

                // Update buttons
                const btns = document.querySelectorAll('.persona-btn');
                btns.forEach(b => {
                    b.classList.remove('active');
                    if (b.textContent === personaUpdate.name) b.classList.add('active');
                });

            } catch (e) { console.error(e); }
        }

        function applyPersonaLayout(data) {
            console.log("Applying Persona:", data.name, data.status);

            // 1. Handle Locked State
            lockedMode = (data.status === 'LOCKED_PREVIEW');
            document.getElementById('locked-banner').style.display = lockedMode ? 'block' : 'none';
            document.body.classList.toggle('locked-mode', lockedMode);

            // Disable/Enable action buttons
            const actionBtns = document.querySelectorAll('.action-btn');
            actionBtns.forEach(btn => {
                btn.disabled = lockedMode;
            });

            // 2. Render Modules
            // Hide all modules first
            const allModules = document.querySelectorAll('.orca-module');
            allModules.forEach(m => m.style.display = 'none');

            // Show allowed modules from layout
            const allowedIds = data.layout.modules.map(m => m.id);
            allowedIds.forEach(mid => {
                const el = document.getElementById(mid);
                if (el) {
                    el.style.display = 'block';
                } else {
                    // Safe placeholder for unknown or missing modules
                    console.warn("Module missing from DOM:", mid);
                    // We could inject a placeholder here if needed
                }
            });

            // 3. Apply Theme (Simple version)
            if (data.theme && data.theme.tokens) {
                const t = data.theme.tokens;
                document.documentElement.style.setProperty('--accent', t.primary || '#00bcd4');
            }
        }

        // --- Marketplace Logic (M9) ---

        let marketplaceOpen = false;

        async function toggleMarketplace() {
            const modal = document.getElementById('marketplace-modal');
            marketplaceOpen = !marketplaceOpen;
            modal.style.display = marketplaceOpen ? 'block' : 'none';
            if (marketplaceOpen) {
                renderMarketplace();
            }
        }

        async function renderMarketplace() {
            try {
                const [catRes, instRes] = await Promise.all([
                    fetch(`${RUNTIME_BASE}/runtime/persona/catalog`),
                    fetch(`${RUNTIME_BASE}/runtime/persona/installed`)
                ]);
                const catalog = await catRes.json();
                const installed = await instRes.json();

                const container = document.getElementById('marketplace-content');
                container.innerHTML = "";

                catalog.forEach(item => {
                    const baseId = item.persona_id ? item.persona_id.split('@')[0] : null;
                    const instMeta = baseId ? installed[baseId] : null;

                    const card = document.createElement('div');
                    card.className = "persona-card";

                    const statusClass = item.unlocked ? "unlocked" : "locked";
                    const statusText = item.unlocked ? "Unlocked" : "Locked";

                    let managementHTML = "";
                    if (instMeta) {
                        managementHTML = `
                            <div class="management-section">
                                <div style="color:#888; font-weight:bold;">Manage Versions:</div>
                                <div class="version-list">
                                    ${instMeta.versions.map(v => `
                                        <div class="version-item">
                                            <span>v${v} ${v === instMeta.active_version ? '<b style="color:var(--accent);">(Active)</b>' : ''}</span>
                                            ${v !== instMeta.active_version ? `<button onclick="rollbackPersona('${baseId}', '${v}')" style="font-size:0.6em; padding:2px 5px; background:#444; color:#fff;">v${v}</button>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <span style="font-size:0.8em; color:#888;">${item.price || 'Free'}</span>
                        </div>
                        <h4 style="margin:5px 0;">${item.name}</h4>
                        <p style="font-size:0.75em; color:#aaa; flex-grow:1;">${item.description || 'Enterprise grade persona bundle.'}</p>
                        <div style="display:flex; gap:8px;">
                            <button onclick="previewPersonaFromStore('${item.persona_id}')" style="flex:1; padding:6px; font-size:0.7em; background:#444; color:#fff;">Preview</button>
                            ${!item.unlocked ? `<button onclick="activatePersona('${item.sku}')" style="flex:1; padding:6px; font-size:0.7em;">Activate</button>` : `<button disabled style="flex:1; padding:6px; font-size:0.7em; background:#2e7d32; color:#fff;">Active</button>`}
                        </div>
                        ${managementHTML}
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error("Catalog load failed", e);
            }
        }

        async function rollbackPersona(pid, version) {
            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/persona/rollback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona_id: pid, version: version })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Switched ${pid} to v${version}`);
                    renderMarketplace();
                    loadPersonas();
                }
            } catch (e) { console.error(e); }
        }

        async function previewPersonaFromStore(personaId) {
            if (!personaId) return alert("This item is not yet available for direct preview.");

            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/persona/preview?persona_id=${personaId}&cap_profile=enterprise`);
                const data = await res.json();

                const panel = document.getElementById('preview-panel');
                const title = document.getElementById('preview-title');
                const body = document.getElementById('preview-body');

                title.textContent = `Preview: ${data.name}`;
                body.innerHTML = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <b>Layout Modules:</b>
                            <ul>${data.layout.modules.map(m => `<li>${m.id} (${m.position})</li>`).join('')}</ul>
                        </div>
                        <div>
                            <b>Status:</b> ${data.status}<br>
                            <b>Price:</b> Professional License ($99/mo)<br>
                            <b>Theme:</b> Primary ${data.theme?.tokens?.primary || '#default'}
                        </div>
                    </div>
                `;
                panel.style.display = 'block';

                // Also apply the layout temporarily
                applyPersonaLayout(data);
            } catch (e) { console.error(e); }
        }

        function exitPreview() {
            document.getElementById('preview-panel').style.display = 'none';
            // Reload original persona
            loadPersonas();
        }

        async function activatePersona(sku) {
            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/persona/activate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sku: sku })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Persona activated successfully!");
                    renderMarketplace();
                    loadPersonas(); // Refresh switcher
                }
            } catch (e) { console.error(e); }
        }

        async function importPersonaZip() {
            const pathInput = document.getElementById('import-zip-path');
            const statusEl = document.getElementById('import-status');
            const zipPath = pathInput.value.trim();

            if (!zipPath) return alert("Please enter a zip path.");

            statusEl.textContent = "Importing...";
            statusEl.style.color = "var(--accent)";

            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/persona/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zip_path: zipPath })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = `Successfully imported ${data.persona_id} v${data.version}`;
                    statusEl.style.color = "#4caf50";
                    pathInput.value = "";
                    renderMarketplace();
                    loadPersonas();
                } else {
                    const errorMsg = data.errors ? data.errors.join(' | ') : "Unknown error";
                    statusEl.textContent = `Import Failed: ${errorMsg}`;
                    statusEl.style.color = "#f44336";
                }
            } catch (e) {
                statusEl.textContent = "Communication error.";
                statusEl.style.color = "#f44336";
            }
        }

        // --- Existing Dashboard Functions (Restored & Cleaned) ---

        async function startRun() {
            try {
                const res = await fetch(`${API_BASE}/runs/start`, { method: 'POST' });
                const data = await res.json();
                currentRunId = data.run_id;
                document.getElementById('btn-start').textContent = "Running";
                document.getElementById('btn-start').style.background = "#4caf50";
            } catch (e) {
                console.warn("API Offline, working in Runtime-only mode");
            }
        }

        async function sendChat() {
            if (lockedMode) return;
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addBubble("user", msg);
            input.value = "";

            const assistantBubble = addBubble("assistant", "...");

            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: msg }]
                    })
                });
                const data = await res.json();
                assistantBubble.textContent = data.content;
            } catch (e) {
                assistantBubble.textContent = "Runtime communication failed.";
                assistantBubble.style.color = "red";
            }
        }

        function addBubble(role, text) {
            const hist = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.style.padding = "10px 15px";
            div.style.borderRadius = "12px";
            div.style.maxWidth = "85%";
            div.style.marginBottom = "8px";
            div.style.fontSize = "0.9em";

            if (role === 'user') {
                div.style.background = "var(--accent)";
                div.style.color = "#000";
                div.style.alignSelf = "flex-end";
            } else {
                div.style.background = "#333";
                div.style.color = "#fff";
                div.style.alignSelf = "flex-start";
            }
            div.textContent = text;
            hist.appendChild(div);
            hist.scrollTop = hist.scrollHeight;
            return div;
        }

        async function speakLastResponse() {
            if (lockedMode) return;
            const status = document.getElementById('tts-status');
            status.textContent = "Synthesizing...";

            // Simple logic: get last assistant bubble
            const bubbles = document.querySelectorAll('#chat-history div');
            let lastText = "Hello from ORCA.";
            for (let i = bubbles.length - 1; i >= 0; i--) {
                if (bubbles[i].style.alignSelf === 'flex-start') {
                    lastText = bubbles[i].textContent;
                    break;
                }
            }

            try {
                const res = await fetch(`${RUNTIME_BASE}/runtime/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: lastText })
                });
                if (!res.ok) throw new Error("TTS Fail");
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const player = document.getElementById('tts-player');
                player.src = url;
                player.style.display = 'block';
                player.play();
                status.textContent = "Ready.";
            } catch (e) {
                status.textContent = "Error.";
            }
        }

        // Settings placeholders
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        async function updateChatModels() { }
        async function updateTTSModels() { }
        async function saveRuntimeSettings() { }
        async function enableLocation() { alert("Location simulated."); }
        async function uploadFile() { alert("Upload simulated."); }

        // --- Director Logic (Flight Recorder) ---

        let directorOpen = false;
        let directorWS = null;

        async function toggleDirector() {
            const modal = document.getElementById('director-modal');
            directorOpen = !directorOpen;
            modal.style.display = directorOpen ? 'flex' : 'none';
            if (directorOpen) {
                initDirectorWS();
                refreshDirectorHUD();
                loadInitialEvents();
                refreshRuns();
            } else {
                if (directorWS) {
                    directorWS.close();
                    directorWS = null;
                }
            }
        }

        function initDirectorWS() {
            if (directorWS) return;
            const wsUrl = RUNTIME_BASE.replace('http', 'ws') + "/api/director/ws";
            directorWS = new WebSocket(wsUrl);

            directorWS.onmessage = (event) => {
                const data = JSON.parse(event.data);
                appendEventToStream(data);
                refreshDirectorHUD();
            };

            directorWS.onclose = () => {
                if (directorOpen) {
                    setTimeout(initDirectorWS, 2000);
                }
            };
        }

        async function refreshDirectorHUD() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/state`);
                const state = await res.json();
                document.getElementById('hud-inbox').textContent = state.counts.inbox;
                document.getElementById('hud-quests').textContent = state.counts.quests;
                document.getElementById('hud-runs').textContent = state.counts.runs;
                document.getElementById('hud-status').textContent = state.status.toUpperCase();
            } catch (e) {
                document.getElementById('hud-status').textContent = "OFFLINE";
            }
        }

        async function loadInitialEvents() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/events?limit=50`);
                const events = await res.json();
                const stream = document.getElementById('director-event-stream');
                stream.innerHTML = "";
                events.forEach(appendEventToStream);
            } catch (e) { console.error(e); }
        }

        function appendEventToStream(ev) {
            const stream = document.getElementById('director-event-stream');
            const div = document.createElement('div');
            div.style.marginBottom = "4px";
            div.style.borderBottom = "1px solid #111";
            div.style.paddingBottom = "2px";

            const ts = new Date(ev.timestamp).toLocaleTimeString();
            const severityColor = ev.severity === 'error' ? '#f44336' : (ev.severity === 'warn' ? '#ff9800' : '#0f0');

            div.innerHTML = `
                <span style="color: #444;">[${ts}]</span>
                <span style="color: #5c6bc0; font-weight: bold;">${ev.type.toUpperCase()}</span>
                <span style="color: #888;">(${ev.source})</span>
                <span style="color: ${severityColor};">${JSON.stringify(ev.payload)}</span>
            `;
            stream.appendChild(div);
            stream.scrollTop = stream.scrollHeight;
        }

        async function refreshRuns() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/runs`);
                const runs = await res.json();
                const list = document.getElementById('director-run-list');
                list.innerHTML = runs.map(r => `
                    <div style="background: #1a1a2e; padding: 10px; margin-bottom: 8px; border-left: 3px solid #5c6bc0; font-size: 0.8em;">
                        <div style="display: flex; justify-content: space-between;">
                            <b style="color: #fff;">RUN: ${r.run_id.substring(0, 8)}</b>
                            <span style="color: ${r.status === 'success' ? '#4caf50' : '#f44336'};">${r.status.toUpperCase()}</span>
                        </div>
                        <div style="color: #888; margin-top: 4px;">${new Date(r.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function triggerTestEvent() {
            try {
                await fetch(`${RUNTIME_BASE}/api/director/events/test`, { method: 'POST' });
            } catch (e) { console.error(e); }
        }

        function switchDirectorTab(tab, btn) {
            document.getElementById('director-recorder-view').style.display = (tab === 'recorder') ? 'grid' : 'none';
            document.getElementById('director-inbox-view').style.display = (tab === 'inbox') ? 'grid' : 'none';
            document.getElementById('director-quests-view').style.display = (tab === 'quests') ? 'grid' : 'none';
            document.getElementById('director-progress-view').style.display = (tab === 'progress') ? 'grid' : 'none';

            document.querySelectorAll('.director-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (tab === 'inbox') refreshInbox();
            if (tab === 'quests') refreshQuests();
            if (tab === 'progress') refreshProgress();
        }

        async function refreshInbox() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/inbox/list`);
                const items = await res.json();
                const list = document.getElementById('inbox-item-list');
                list.innerHTML = items.map(item => `
                    <div class="inbox-item" onclick="previewInboxItem('${item.id}')">
                        <div style="width: 30px; height: 30px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 0.6em; color: #5c6bc0;">
                            ${item.type === 'image' ? 'IMG' : '???'}
                        </div>
                        <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <div style="font-size: 0.8em; color: #eee;">${item.filenames[0]}</div>
                            <div style="font-size: 0.6em; color: #666;">${new Date(item.created_ts).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function uploadInboxFile() {
            const input = document.getElementById('inbox-upload-input');
            if (input.files.length === 0) return;

            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/inbox/upload`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    input.value = "";
                    refreshInbox();
                    refreshDirectorHUD();
                }
            } catch (e) { console.error(e); }
        }

        async function previewInboxItem(id) {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/inbox/list`);
                const items = await res.json();
                const item = items.find(i => i.id === id);
                if (!item) return;

                const ocrRes = await fetch(`${RUNTIME_BASE}/api/director/inbox/${id}/artifacts/derived/ocr.txt`);
                const ocrText = await ocrRes.text();

                const pane = document.getElementById('inbox-preview-pane');
                pane.innerHTML = `
                    <h3 style="color: #5c6bc0; border-bottom: 1px solid #333; padding-bottom: 10px;">ASSET_DETAILS: ${item.filenames[0]}</h3>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <div style="flex: 1;">
                            <img src="${RUNTIME_BASE}/api/director/inbox/${id}/artifacts/derived/preview.jpg" style="max-width: 100%; border: 1px solid #333; border-radius: 4px;">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div style="color: #5c6bc0; font-size: 0.7em; font-weight: bold; margin-bottom: 5px;">OCR_DATA</div>
                            <div id="ocr-content" style="flex: 1; background: #000; border: 1px solid #333; padding: 10px; font-size: 0.8em; color: #aaa; white-space: pre-wrap; font-family: monospace;">${ocrText}</div>
                            <button onclick="createQuestFromAsset('${id}', '${item.filenames[0]}')" style="margin-top: 15px; background: #5c6bc0; color: #fff; border: none; padding: 8px; cursor: pointer; font-weight: bold;">CREATE QUEST FROM ASSET</button>
                        </div>
                    </div>
                `;

            } catch (e) { console.error(e); }
        }

        async function createQuestFromAsset(inbox_id, filename) {
            const title = prompt("Quest Title", `Analyze ${filename}`);
            if (!title) return;
            const acceptance = prompt("Acceptance Criteria", "Verify OCR data matches intent.");

            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/quests/from_inbox`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inbox_id, title, acceptance })
                });
                if (res.ok) {
                    alert("Quest created!");
                    refreshDirectorHUD();
                    refreshQuests(); // Refresh quests after creation
                }
            } catch (e) { console.error(e); }
        }

        async function refreshQuests() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/quests`);
                const data = await res.json();

                const renderCol = (listId, questIds) => {
                    const el = document.getElementById(listId);
                    el.innerHTML = "";
                    questIds.forEach(qid => {
                        const q = data.quests.find(x => x.id === qid);
                        if (!q) return;

                        const div = document.createElement('div');
                        div.className = "quest-item";
                        div.innerHTML = `
                            <div class="quest-card-header">
                                <span class="quest-card-title">${q.title}</span>
                                <span class="quest-card-meta">${q.id.substring(0, 8)}</span>
                            </div>
                            <div class="quest-card-meta">Created: ${new Date(q.created_ts).toLocaleString()}</div>
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                ${q.status !== 'active' ? `<button onclick="setQuestStatus('${q.id}', 'active')" style="background:#2e7d32; border:none; color:#fff; font-size:0.7em; padding:2px 5px; cursor:pointer;">ACTIVE</button>` : ''}
                                ${q.status !== 'next' ? `<button onclick="setQuestStatus('${q.id}', 'next')" style="background:#e65100; border:none; color:#fff; font-size:0.7em; padding:2px 5px; cursor:pointer;">NEXT</button>` : ''}
                                ${q.status !== 'later' ? `<button onclick="setQuestStatus('${q.id}', 'later')" style="background:#555; border:none; color:#fff; font-size:0.7em; padding:2px 5px; cursor:pointer;">LATER</button>` : ''}
                            </div>
                        `;
                        el.appendChild(div);
                    });
                };

                renderCol('quest-list-active', data.active);
                renderCol('quest-list-next', data.next);
                renderCol('quest-list-later', data.later);
            } catch (e) { console.error(e); }
        }

        async function setQuestStatus(quest_id, status) {
            try {
                await fetch(`${RUNTIME_BASE}/api/director/quests/set_status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quest_id, status })
                });
                refreshQuests();
                refreshDirectorHUD();
            } catch (e) { console.error(e); }
        }

        function updateSystemTime() {
            const now = new Date();
            document.getElementById('system-time').textContent = now.toLocaleTimeString();
        }

        // Boot
        setInterval(updateSystemTime, 1000);
        updateSystemTime();
        loadPersonas();

        async function refreshProgress() {
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/progress`);
                const data = await res.json();

                // Fetch actions for the capabilities
                const aRes = await fetch(`${RUNTIME_BASE}/api/director/capabilities/actions`);
                const capActions = await aRes.json();

                // Render Milestones
                const mList = document.getElementById('progress-milestones-list');
                mList.innerHTML = data.milestones.map(m => `
                    <div class="progress-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:#5c6bc0;">${m.title}</span>
                            <span style="font-size:0.7em; padding:2px 4px; border:1px solid #333; color:${m.status === 'done' ? '#4caf50' : '#888'}">${m.status.toUpperCase()}</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            ${m.status !== 'done' ? `<button onclick="setMilestoneStatus('${m.id}', 'done')" style="font-size:0.7em;">MARK DONE</button>` : ''}
                        </div>
                    </div>
                `).join('');

                // Render Capabilities
                const cList = document.getElementById('progress-capabilities-list');
                cList.innerHTML = data.milestones.length > 0 ? "" : ""; // Clear if needed? No, data.capabilities_summary is counts

                // We'll show the actual capabilities here since we want to Run them
                const cRes = await fetch(`${RUNTIME_BASE}/api/director/capabilities`);
                const cData = await cRes.json();
                cList.innerHTML = cData.catalog.map(cap => {
                    const actions = capActions.find(ca => ca.id === cap.id)?.actions || [];
                    return `
                        <div class="progress-card">
                            <div style="display:flex; justify-content:space-between;">
                                <span style="font-weight:bold;">${cap.title}</span>
                                <span style="font-size:0.7em; color:#888;">${cap.status.toUpperCase()}</span>
                            </div>
                            <div style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;">
                                ${actions.map(a => `<button onclick="runCapabilityDialog('${cap.id}', '${a.id}')" style="font-size:0.7em; background:#2e7d32; color:#fff; border:none; padding:2px 5px;">RUN: ${a.title}</button>`).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                // Render Quests
                const qList = document.getElementById('progress-quests-list');
                qList.innerHTML = `
                    <div class="progress-card"><div>ACTIVE: <b>${data.quests_summary.active}</b></div></div>
                    <div class="progress-card"><div>NEXT: <b>${data.quests_summary.next}</b></div></div>
                    <div class="progress-card"><div>LATER: <b>${data.quests_summary.later}</b></div></div>
                `;

                // Render Issues
                const iList = document.getElementById('progress-issues-list');
                iList.innerHTML = data.issues.map(i => `
                    <div class="progress-card severity-${i.severity}">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold;">${i.title}</span>
                            <span style="font-size:0.75em; color:#888;">${i.status.toUpperCase()}</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            ${i.status === 'open' ? `<button onclick="setIssueStatus('${i.id}', 'in_progress')" style="font-size:0.7em;">START</button>` : ''}
                            ${i.status === 'in_progress' ? `<button onclick="setIssueStatus('${i.id}', 'fixed')" style="font-size:0.7em;">FIX</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        let activeRunParams = {};
        async function runCapabilityDialog(capId, actionId) {
            const aRes = await fetch(`${RUNTIME_BASE}/api/director/capabilities/actions`);
            const capActions = await aRes.json();
            const action = capActions.find(ca => ca.id === capId).actions.find(a => a.id === actionId);

            document.getElementById('action-modal-title').textContent = action.title;
            document.getElementById('action-modal-desc').textContent = action.description || "";

            const paramsDiv = document.getElementById('action-modal-params');
            paramsDiv.innerHTML = "";
            activeRunParams = {};

            const props = action.param_schema.properties;
            for (const [key, spec] of Object.entries(props)) {
                const label = document.createElement('label');
                label.textContent = `${key} (${spec.type})`;
                label.style.display = "block";
                label.style.fontSize = "0.8em";
                label.style.marginTop = "10px";

                const input = document.createElement('input');
                input.style.width = "100%";
                input.style.background = "#222";
                input.style.color = "#fff";
                input.style.border = "1px solid #444";
                input.style.padding = "5px";

                if (spec.type === 'integer' || spec.type === 'number') {
                    input.type = "number";
                    if (spec.minimum !== undefined) input.min = spec.minimum;
                    if (spec.maximum !== undefined) input.max = spec.maximum;
                } else {
                    input.type = "text";
                }

                input.value = spec.default !== undefined ? spec.default : "";

                input.onchange = (e) => {
                    activeRunParams[key] = spec.type === 'integer' ? parseInt(e.target.value) : (spec.type === 'number' ? parseFloat(e.target.value) : e.target.value);
                };

                // Set initial default
                activeRunParams[key] = spec.type === 'integer' ? parseInt(input.value) : (spec.type === 'number' ? parseFloat(input.value) : input.value);

                paramsDiv.appendChild(label);
                paramsDiv.appendChild(input);
            }

            document.getElementById('action-modal-submit').onclick = () => submitCapabilityRun(capId, actionId, activeRunParams);
            document.getElementById('action-modal').style.display = "flex";
        }

        function closeActionModal() {
            document.getElementById('action-modal').style.display = "none";
        }

        async function submitCapabilityRun(capability_id, action_id, params) {
            closeActionModal();
            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/capabilities/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ capability_id, action_id, params })
                });
                if (res.ok) {
                    const data = await res.json();
                    alert(`Run started: ${data.run_id}`);
                    refreshRuns();
                } else {
                    const err = await res.json();
                    alert(`Error: ${err.detail}`);
                }
            } catch (e) { console.error(e); }
        }

        async function createIssueDialog() {
            const title = prompt("Issue Title");
            if (!title) return;
            const severity = prompt("Severity (low|med|high|crit)", "med");

            try {
                const res = await fetch(`${RUNTIME_BASE}/api/director/issues/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, severity })
                });
                if (res.ok) {
                    refreshProgress();
                    refreshDirectorHUD();
                }
            } catch (e) { console.error(e); }
        }

        async function setIssueStatus(id, status) {
            try {
                await fetch(`${RUNTIME_BASE}/api/director/issues/set_status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                });
                refreshProgress();
            } catch (e) { console.error(e); }
        }

        async function setMilestoneStatus(id, status) {
            try {
                await fetch(`${RUNTIME_BASE}/api/director/milestones/set_status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                });
                refreshProgress();
            } catch (e) { console.error(e); }
        }
    </script>
    <div id="action-modal" class="modal">
        <div class="modal-content">
            <h3 id="action-modal-title" style="margin-top:0;">Run Action</h3>
            <p id="action-modal-desc" style="font-size:0.8em; color:#888;"></p>
            <div id="action-modal-params" style="margin:20px 0;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeActionModal()"
                    style="background:#333; color:#fff; border:none; padding:5px 15px; cursor:pointer;">CANCEL</button>
                <button id="action-modal-submit"
                    style="background:#5c6bc0; color:#fff; border:none; padding:5px 15px; cursor:pointer;">EXECUTE</button>
            </div>
        </div>
    </div>
</body>

</html>